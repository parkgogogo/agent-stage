# Agentstage CLI Review Report (å°é¾™è™¾ + Codex è”åˆå®¡æŸ¥)

## æ‰§è¡Œå®¡æŸ¥è€…
- **å°é¾™è™¾**: æ¶æ„å’Œè®¾è®¡å®¡æŸ¥
- **Codex (OpenAI)**: ä»£ç è´¨é‡å’Œå®‰å…¨å®¡æŸ¥

---

## ğŸ”´ P0 - ä¸¥é‡é—®é¢˜ (é˜»å¡ä½¿ç”¨)

### 1. `page add` ä¸æ”¯æŒ stdin (è®¾è®¡ç¼ºé™·)
**æ–‡ä»¶**: `packages/cli/src/commands/page/add.ts`

**é—®é¢˜**:
```bash
# âŒ æ— æ³•ç®¡é“è¾“å…¥
echo '{"root":"main",...}' | agentstage page add todo

# âœ… åªèƒ½ç”¨å‘½ä»¤è¡Œå‚æ•°
agentstage page add todo --ui '{"root":"main",...}'
```

**å½±å“**: AI ç”Ÿæˆçš„å¤§å‹ JSON æ— æ³•é€šè¿‡ç®¡é“ç›´æ¥å†™å…¥ï¼Œè¿èƒŒè‡ªåŠ¨åŒ–åŸåˆ™

**ä¿®å¤**:
```typescript
// å½“ --ui çœç•¥ä¸” stdin æœ‰æ•°æ®æ—¶ï¼Œä» stdin è¯»å–
if (!options.ui && !process.stdin.isTTY) {
  const input = await readStdin();
  uiContent = JSON.parse(input);
}
```

### 2. `page rm` è·¯å¾„éå†é£é™© (å®‰å…¨æ¼æ´)
**æ–‡ä»¶**: `packages/cli/src/commands/page/rm.ts:22`

**é—®é¢˜**:
```typescript
const typeFile = join(workspaceDir, '.agentstage', 'types', `${name}.d.ts`);
```

è™½ç„¶ `name` æœ‰æ­£åˆ™éªŒè¯ `/^[a-z0-9-]+$/`ï¼Œä½†åˆ é™¤ `.agentstage/types/` ä¸‹çš„æ–‡ä»¶æ—¶ï¼Œå¦‚æœ `name` åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆè™½ç„¶è¢«é˜»æ­¢ï¼‰ï¼Œæˆ–æœªæ¥éªŒè¯æ”¾å®½ï¼Œå¯èƒ½å¯¼è‡´ç›®å½•éå†ã€‚

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ `FileStore` çš„éªŒè¯é€»è¾‘

---

## ğŸŸ¡ P1 - é‡è¦é—®é¢˜ (ä¸¥é‡å½±å“ä½“éªŒ)

### 3. ç¼ºå°‘ `page update` å‘½ä»¤ (åŠŸèƒ½ç¼ºå¤±)
**ç°çŠ¶**: åªèƒ½åˆ›å»º/åˆ é™¤ï¼Œä¸èƒ½ä¿®æ”¹å·²å­˜åœ¨é¡µé¢

**å½±å“**: AI æ— æ³•é€šè¿‡ CLI ä¿®æ”¹é¡µé¢ UIï¼Œè¿èƒŒæ–‡ä»¶éš”ç¦»åŸåˆ™

**å»ºè®®**:
```bash
agentstage page update <name> --ui '{...}' --state '{...}'
```

### 4. `run exec` ä¸ json-render å†…ç½® actions ä¸å…¼å®¹ (æ¶æ„é—®é¢˜)
**æ–‡ä»¶**: `packages/cli/src/commands/run/exec.ts`

**é—®é¢˜**:
- `run exec` è°ƒç”¨çš„æ˜¯ bridge çš„è‡ªå®šä¹‰ action handler
- ä½† json-render çš„å†…ç½® actionsï¼ˆ`setState`/`pushState`/`removeState`ï¼‰åœ¨å®¢æˆ·ç«¯è§£æ
- **æ— æ³•é€šè¿‡ CLI è§¦å‘ json-render å†…ç½® actions**

**å½±å“**: Agent æ— æ³•é€šè¿‡ CLI è§¦å‘é¡µé¢äº¤äº’

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ–¹æ¡ˆ A: æ·»åŠ ä¸“é—¨çš„ state æ“ä½œå‘½ä»¤
agentstage run patch <page> '{"op": "add", "path": "/count", "value": 1}'

# æ–¹æ¡ˆ B: æ‰©å±• exec æ”¯æŒå†…ç½® actions
agentstage run exec <page> :setState '{"statePath": "/count", "value": 1}'
```

### 5. é”™è¯¯æ¶ˆæ¯ä¸ä¸€è‡´ (ç”¨æˆ·ä½“éªŒ)
**æ–‡ä»¶**: å¤šä¸ªæ–‡ä»¶

**é—®é¢˜**:
```typescript
// run/set-state.ts, run/get-state.ts
consola.error('Project not initialized. Please run `agentstage dev init` first.');

// page/rm.ts
consola.error('Project not initialized. Please run `agentstage init` first.');
```

**å½±å“**: ç”¨æˆ·å›°æƒ‘ï¼Œä¸çŸ¥é“åˆ°åº•è¯¥ç”¨ `init` è¿˜æ˜¯ `dev init`

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ `agentstage init`

---

## ğŸŸ¢ P2 - æ”¹è¿›å»ºè®®

### 6. æµ‹è¯•è¦†ç›–ä¸è¶³ (ä»£ç è´¨é‡)
**æ–‡ä»¶**: `packages/cli/test/smoke.test.ts`

**é—®é¢˜**:
- åªæœ‰åŸºæœ¬çš„ `page add creates files` æµ‹è¯•
- æ²¡æœ‰é’ˆå¯¹ `rm`ã€`set-state`ã€`get-state` çš„æµ‹è¯•
- æ²¡æœ‰è¾¹ç•Œæ¡ä»¶æµ‹è¯•

**é£é™©**: å›å½’é£é™©é«˜

### 7. `page add` çš„ç±»å‹ç”Ÿæˆä¸ä¸€è‡´ (åŠŸèƒ½ç¼ºé™·)
**æ–‡ä»¶**: `packages/cli/src/commands/page/add.ts`

**é—®é¢˜**: 
- æ—©æœŸç‰ˆæœ¬ç”Ÿæˆ `.agentstage/types/${name}.d.ts`
- å½“å‰ç‰ˆæœ¬ä¸å†ç”Ÿæˆï¼Œä½† `page rm` ä»å°è¯•åˆ é™¤è¯¥æ–‡ä»¶
- æµ‹è¯• `smoke.test.ts` ä»æ£€æŸ¥è¯¥æ–‡ä»¶

**å»ºè®®**: ç»Ÿä¸€ç§»é™¤ç±»å‹ç”Ÿæˆé€»è¾‘ï¼Œæˆ–æ¢å¤ç”ŸæˆåŠŸèƒ½

### 8. `--pretty` é»˜è®¤å€¼å¤„ç† (æ½œåœ¨ Bug)
**æ–‡ä»¶**: `packages/cli/src/commands/run/get-state.ts:13`

**é—®é¢˜**:
```typescript
.option('-p, --pretty', 'Pretty print JSON', true)
```

**é£é™©**: Commander çš„å¸ƒå°”é»˜è®¤å€¼å¤„ç†å¯èƒ½ä¸ç¬¦åˆé¢„æœŸ

---

## ğŸ¯ ç¬¬ä¸€æ€§åŸç†è¯„ä¼°

| åŸåˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **å•ä¸€èŒè´£** | âœ… | page/run/dev åˆ†å·¥æ¸…æ™° |
| **æ–‡ä»¶éš”ç¦»** | âš ï¸ | åŸºæœ¬éš”ç¦»ï¼Œä½†ç¼ºå°‘ update å‘½ä»¤ |
| **ç»„åˆè®¾è®¡** | âœ… | --ui + --state ç»„åˆ |
| **stdin æ”¯æŒ** | âŒ | ç¼ºå¤±ï¼Œä¸¥é‡å½±å“ AI é›†æˆ |
| **å®Œæ•´ CRUD** | âŒ | ç¼º updateï¼Œä¸å®Œæ•´ |
| **ç»Ÿä¸€é”™è¯¯** | âŒ | é”™è¯¯æ¶ˆæ¯ä¸ä¸€è‡´ |

**æ€»ä½“è¯„åˆ†: 6/10**

---

## ğŸ”§ ç«‹å³ä¿®å¤æ¸…å•

### å¿…é¡»ç”± å°é¾™è™¾ ä¿®å¤ (P0)
1. âœ… **æ·»åŠ  stdin æ”¯æŒåˆ° page add** - å·²ç¡®è®¤éœ€è¦
2. âœ… **ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯** - ç»Ÿä¸€ä½¿ç”¨ `agentstage init`

### å»ºè®®ä¿®å¤ (P1)
3. **æ·»åŠ  `page update` å‘½ä»¤** - å®Œæˆ CRUD
4. **è§£å†³ exec ä¸å†…ç½® actions ä¸å…¼å®¹** - æ·»åŠ  `run patch` å‘½ä»¤
5. **ä¿®å¤ç±»å‹ç”Ÿæˆä¸ä¸€è‡´** - ç»Ÿä¸€ç§»é™¤æˆ–æ¢å¤

### é•¿æœŸæ”¹è¿› (P2)
6. **å¢åŠ æµ‹è¯•è¦†ç›–** - è‡³å°‘è¦†ç›–ä¸»è¦å‘½ä»¤
7. **æ·»åŠ è·¯å¾„éå†é˜²æŠ¤** - ç»Ÿä¸€ä½¿ç”¨ `FileStore` éªŒè¯

---

## Codex é¢å¤–å‘ç°

1. **æ— æµ‹è¯•è„šæœ¬**: `packages/cli` æ²¡æœ‰ `test` scriptï¼Œåªæœ‰ `smoke.test.ts`
2. **TypeScript ç¼–è¯‘é€šè¿‡**: `pnpm typecheck` é€šè¿‡ï¼Œæ— ç¼–è¯‘é”™è¯¯
3. **å‘½ä»¤ç»“æ„æ¸…æ™°**: `dev`/`page`/`run` ä¸‰å±‚ç»“æ„åˆç†

---

## ç»“è®º

**å½“å‰çŠ¶æ€**: å¯ç”¨ä½†ä¸å¤Ÿå®Œå–„

**æ ¸å¿ƒç¼ºå¤±**:
1. stdin æ”¯æŒï¼ˆAI é›†æˆå¿…éœ€ï¼‰- P0
2. page updateï¼ˆå®Œæ•´ CRUDï¼‰- P1  
3. å†…ç½® actions è§¦å‘ï¼ˆäº¤äº’èƒ½åŠ›ï¼‰- P1

**å»ºè®®ä¼˜å…ˆçº§**:
1. ç«‹å³ä¿®å¤ stdin æ”¯æŒ
2. ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯
3. æ·»åŠ  page update å‘½ä»¤

**Agent ä½¿ç”¨ä½“éªŒ**: 6/10
- âœ… å¯ä»¥åˆ›å»ºé¡µé¢
- âœ… å¯ä»¥è®¾ç½®/è¯»å–çŠ¶æ€
- âŒ æ— æ³•ç®¡é“è¾“å…¥å¤§å‹ JSON
- âŒ æ— æ³•æ›´æ–°å·²å­˜åœ¨é¡µé¢
- âŒ æ— æ³•è§¦å‘å†…ç½® actions

---

*å®¡æŸ¥æ—¶é—´: 2026-02-19*
*å®¡æŸ¥è€…: å°é¾™è™¾ ğŸ¦ + Codex ğŸ¤–*
